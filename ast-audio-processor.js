import { ASTDecoder } from "data:application/x-javascript;base64,CmV4cG9ydCBjbGFzcyBBU1RIZWFkZXIgewogICAgLyoqCiAgICAgKiBTZXRzIGZpZWxkcyBhY2NvcmRpbmcgdG8gcHJvcGVydGllcyBpbiBBU1QgZmlsZSBoZWFkZXIuCiAgICAgKiBAcGFyYW0ge1VpbnQ4QXJyYXl9IGFzdERhdGEgVGhlIGNvbnRlbnRzIG9mIGFuIEFTVCBmaWxlLgogICAgICovCiAgICBjb25zdHJ1Y3Rvcihhc3REYXRhKSB7CiAgICAgICAgaWYgKGFzdERhdGEubGVuZ3RoIDwgMHg0MCArIDMyKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRmlsZSBkYXRhIGlzIG5vdCBpbiBBU1QgZm9ybWF0OyBub3QgZW5vdWdoIGZpbGUgZGF0YSB0byBmaXQgZW50aXJlIEFTVCBoZWFkZXIgYW5kIGJlZ2lubmluZyBvZiBmaXJzdCBCTENLIGNodW5rIik7CiAgICAgICAgfQoKICAgICAgICAvLyBSZWFkIGZpbGUgbWFnaWMgbnVtYmVyCiAgICAgICAgbGV0IG1hZ2ljID0gcmVhZEJFKGFzdERhdGEsIDAsIDQpOwogICAgICAgIGlmIChtYWdpYyA9PT0gMHg1MzU0NTI0RCkgewogICAgICAgICAgICAvLyAweDUzNTQ1MjREID0gIlNUUk0iIC0+IGJpZy1lbmRpYW4gQVNUCiAgICAgICAgICAgIHRoaXMucmVhZCA9IHJlYWRCRTsKICAgICAgICB9IGVsc2UgaWYgKG1hZ2ljID09PSAweDRENTI1NDUzKSB7CiAgICAgICAgICAgIC8vIDB4NEQ1MjU0NTMgPSAiTVJUUyIgLT4gbGl0dGxlLWVuZGlhbiBBU1QKICAgICAgICAgICAgdGhpcy5yZWFkID0gcmVhZExFOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRmlsZSBkYXRhIGlzIG5vdCBpbiBBU1QgZm9ybWF0OyBtaXNzaW5nIFwiU1RSTVwiIG1hZ2ljIG51bWJlciIpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5kYXRhU2l6ZSA9IHRoaXMucmVhZChhc3REYXRhLCA0LCA0KTsKICAgICAgICB0aGlzLmF1ZGlvRm9ybWF0ID0gcmVhZEJFKGFzdERhdGEsIDgsIDIpOyAvLyAwID0gQURQQ00sIDEgPSBQQ00xNgogICAgICAgIGlmICh0aGlzLmF1ZGlvRm9ybWF0ID4gMSkgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlVucmVjb2duaXplZCBhdWRpbyBmb3JtYXQ7IHRoaXMgZGVjb2RlciBvbmx5IHJlY29nbml6ZXMgZm9ybWF0cyAwID0gQURQQ00sIDEgPSBQQ00xNiwgYnV0IHRoaXMgZmlsZSB1c2VzIGZvcm1hdCAiICsgdGhpcy5hdWRpb0Zvcm1hdCk7CiAgICAgICAgfQogICAgICAgIHRoaXMuYml0c1BlclNhbXBsZSA9IHRoaXMucmVhZChhc3REYXRhLCAxMCwgMik7CiAgICAgICAgdGhpcy5udW1DaGFubmVscyA9IHRoaXMucmVhZChhc3REYXRhLCAxMiwgMik7CiAgICAgICAgaWYgKHRoaXMubnVtQ2hhbm5lbHMgPT09IDApIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJOdW1iZXIgb2YgYXVkaW8gY2hhbm5lbHMgY2Fubm90IGJlIDAiKTsKICAgICAgICB9CiAgICAgICAgdGhpcy51bmtub3duMSA9IHJlYWRCRShhc3REYXRhLCAxNCwgMik7CiAgICAgICAgdGhpcy5zYW1wbGVSYXRlID0gdGhpcy5yZWFkKGFzdERhdGEsIDE2LCA0KTsKICAgICAgICB0aGlzLm51bVNhbXBsZXMgPSB0aGlzLnJlYWQoYXN0RGF0YSwgMjAsIDQpOwogICAgICAgIHRoaXMubG9vcFN0YXJ0ID0gdGhpcy5yZWFkKGFzdERhdGEsIDI0LCA0KTsKICAgICAgICB0aGlzLmxvb3BFbmQgPSB0aGlzLnJlYWQoYXN0RGF0YSwgMjgsIDQpOwogICAgICAgIHRoaXMuZmlyc3RDaHVua1NpemUgPSB0aGlzLnJlYWQoYXN0RGF0YSwgMzIsIDQpOwogICAgICAgIHRoaXMudW5rbm93bjIgPSByZWFkQkUoYXN0RGF0YSwgMzYsIDQpOwogICAgICAgIHRoaXMudW5rbm93bjMgPSByZWFkQkUoYXN0RGF0YSwgNDAsIDQpOwogICAgfQp9CgpleHBvcnQgY2xhc3MgQVNURGVjb2RlciB7CiAgICAvKioKICAgICAqIFJlYWRzIGluIHRoZSBoZWFkZXIgb2YgdGhlIHByb3ZpZGVkIEFTVCBmaWxlLCBzZXRzIGZpZWxkcyBhY2NvcmRpbmcgdG8gdGhlIGNvbnRhaW5lZCBwcm9wZXJ0aWVzLAogICAgICogYW5kIHByZXBhcmVzIGRlY29kZXIgdG8gZGVjb2RlIHRoZSByZXN0IG9mIHRoZSBmaWxlLgogICAgICogQHBhcmFtIHtVaW50OEFycmF5fSBhc3REYXRhIFRoZSBjb250ZW50cyBvZiBhbiBBU1QgZmlsZS4KICAgICAqLwogICAgY29uc3RydWN0b3IoYXN0RGF0YSkgewogICAgICAgIHRoaXMuYXN0RGF0YSA9IGFzdERhdGE7CgogICAgICAgIC8vIE1haW4gaGVhZGVyCiAgICAgICAgdGhpcy5oZWFkZXIgPSBuZXcgQVNUSGVhZGVyKGFzdERhdGEpOwogICAgICAgIHRoaXMucmVhZCA9IHRoaXMuaGVhZGVyLnJlYWQ7CgogICAgICAgIC8vIFNldCB1cCBkZWNvZGVyCiAgICAgICAgdGhpcy5kZWNvZGVkU2FtcGxlcyA9IEFycmF5KHRoaXMuaGVhZGVyLm51bUNoYW5uZWxzKTsKICAgICAgICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IHRoaXMuZGVjb2RlZFNhbXBsZXMubGVuZ3RoOyBjaGFubmVsKyspIHsKICAgICAgICAgICAgdGhpcy5kZWNvZGVkU2FtcGxlc1tjaGFubmVsXSA9IFtdOwogICAgICAgIH0KICAgICAgICB0aGlzLmRlY29kZXJQb3NpdGlvbiA9IDB4NDA7CiAgICAgICAgdGhpcy5kZWNvZGVyU2FtcGxlID0gMDsKICAgICAgICB0aGlzLmRlY29kZXJGaW5pc2hlZCA9IGZhbHNlOwogICAgICAgIHRoaXMuZGVjb2RlckVuZFNhbXBsZSA9IDA7CiAgICAgICAgdGhpcy5vdXRwdXRTYW1wbGUgPSAwOwogICAgICAgIHRoaXMubnVtQ2h1bmtzID0gMDsKICAgICAgICAKICAgICAgICAvLyBBRFBDTSBkZWNvZGVyIHN0YXRlCiAgICAgICAgdGhpcy5hZHBjbVNoaWZ0ID0gQXJyYXkodGhpcy5oZWFkZXIubnVtQ2hhbm5lbHMpLmZpbGwoMCk7CiAgICAgICAgdGhpcy5hZHBjbUZpbHRlciA9IEFycmF5KHRoaXMuaGVhZGVyLm51bUNoYW5uZWxzKS5maWxsKDApOwogICAgICAgIHRoaXMuYWRwY21PbGQgPSBBcnJheSh0aGlzLmhlYWRlci5udW1DaGFubmVscykuZmlsbCgwKTsKICAgICAgICB0aGlzLmFkcGNtT2xkZXIgPSBBcnJheSh0aGlzLmhlYWRlci5udW1DaGFubmVscykuZmlsbCgwKTsKICAgICAgICB0aGlzLmFkcGNtTGFzdEJ5dGVXYXNIZWFkZXIgPSBBcnJheSh0aGlzLmhlYWRlci5udW1DaGFubmVscykuZmlsbChmYWxzZSk7CiAgICB9CgogICAgbmV4dEJsb2NrKCkgewogICAgICAgIGlmICh0aGlzLmRlY29kZXJGaW5pc2hlZCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLmRlY29kZXJQb3NpdGlvbiA+PSB0aGlzLmFzdERhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgIHRoaXMuZGVjb2RlckZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KICAgICAgICBsZXQgaSA9IHRoaXMuZGVjb2RlclBvc2l0aW9uOwogICAgICAgIGlmICgodGhpcy5hc3REYXRhLmxlbmd0aCAtIGkpIDwgMzIpIHsKICAgICAgICAgICAgdGhpcy5kZWNvZGVyRXJyb3IoIkZvdW5kIGJ5dGVzIGF0IGV4cGVjdGVkIGJlZ2lubmluZyBvZiBuZXh0IEJMQ0sgY2h1bmssIGJ1dCB0aGVyZSBhcmUgbm90IGVub3VnaCByZW1haW5pbmcgdG8gZm9ybSBhIGNvbXBsZXRlIEJMQ0sgY2h1bmsgaGVhZGVyLiBUaGV5IHdpbGwgYmUgaWdub3JlZC4iKTsKICAgICAgICAgICAgdGhpcy5kZWNvZGVyRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIC8vICJCTENLIiA9IDB4NDI0QzQzNEIKICAgICAgICBpZiAoISh0aGlzLnJlYWQodGhpcy5hc3REYXRhLCBpLCA0KSA9PT0gMHg0MjRDNDM0QikpIHsKICAgICAgICAgICAgdGhpcy5kZWNvZGVyRXJyb3IoIk1pc3NpbmcgXCJCTENLXCIgbWFnaWMgbnVtYmVyIHdoZXJlIEJMQ0sgY2h1bmsgIiArIHRoaXMubnVtQ2h1bmtzICsgIiBpcyBleHBlY3RlZCB0byBzdGFydC4gUmVtYWluaW5nIGJ5dGVzIHdpbGwgYmUgaWdub3JlZC4iKTsKICAgICAgICAgICAgdGhpcy5kZWNvZGVyRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfQogICAgICAgIGkgKz0gNDsKICAgICAgICBjb25zdCBibG9ja1NpemUgPSB0aGlzLnJlYWQodGhpcy5hc3REYXRhLCBpLCA0KTsKICAgICAgICBpICs9IDI4OwogICAgICAgIGNvbnN0IGNodW5rU3RhcnQgPSBpOwogICAgICAgIGxldCBpdGVyOwogICAgICAgIGxldCBhZHBjbVNoaWZ0OwogICAgICAgIGxldCBhZHBjbUZpbHRlcjsKICAgICAgICBsZXQgYWRwY21PbGQ7CiAgICAgICAgbGV0IGFkcGNtT2xkZXI7CiAgICAgICAgbGV0IGFkcGNtTGFzdEJ5dGVXYXNIZWFkZXI7CiAgICAgICAgCiAgICAgICAgaWYgKHRoaXMuaGVhZGVyLmF1ZGlvRm9ybWF0ID09PSAwKSB7CiAgICAgICAgICAgIC8vIEFEUENNCiAgICAgICAgICAgIGl0ZXIgPSAoY2hhbm5lbCwgaSkgPT4gewogICAgICAgICAgICAgICAgY29uc3QgYnl0ZSA9IHRoaXMuYXN0RGF0YVtpXTsKICAgICAgICAgICAgICAgIGlmICh0aGlzLmRlY29kZXJTYW1wbGUgJSAxNiA9PT0gMCAmJiAhYWRwY21MYXN0Qnl0ZVdhc0hlYWRlcikgewogICAgICAgICAgICAgICAgICAgIC8vIFJlYWQgQURQQ00gaGVhZGVyIGJ5dGVzIGZvciBlYWNoIGNoYW5uZWwKICAgICAgICAgICAgICAgICAgICBhZHBjbVNoaWZ0ID0gYnl0ZSA+Pj4gNDsKICAgICAgICAgICAgICAgICAgICBhZHBjbUZpbHRlciA9IGJ5dGUgJiAwYjExMTE7CiAgICAgICAgICAgICAgICAgICAgYWRwY21MYXN0Qnl0ZVdhc0hlYWRlciA9IHRydWU7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGFkcGNtTGFzdEJ5dGVXYXNIZWFkZXIgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAvLyBVcHBlciBuaWJibGUKICAgICAgICAgICAgICAgICAgICBjb25zdCBzYW1wbGVWYWx1ZTEgPSBhZHBjbURlY29kZShhZHBjbVNoaWZ0LCBhZHBjbUZpbHRlciwgYnl0ZSA+Pj4gNCwgYWRwY21PbGQsIGFkcGNtT2xkZXIpOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlZFNhbXBsZXNbY2hhbm5lbF0ucHVzaChzYW1wbGVWYWx1ZTEpOwogICAgICAgICAgICAgICAgICAgIGFkcGNtT2xkZXIgPSBhZHBjbU9sZDsKICAgICAgICAgICAgICAgICAgICBhZHBjbU9sZCA9IHNhbXBsZVZhbHVlMTsKCiAgICAgICAgICAgICAgICAgICAgLy8gTG93ZXIgbmliYmxlCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2FtcGxlVmFsdWUyID0gYWRwY21EZWNvZGUoYWRwY21TaGlmdCwgYWRwY21GaWx0ZXIsIGJ5dGUgJiAwYjExMTEsIGFkcGNtT2xkLCBhZHBjbU9sZGVyKTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY29kZWRTYW1wbGVzW2NoYW5uZWxdLnB1c2goc2FtcGxlVmFsdWUyKTsKICAgICAgICAgICAgICAgICAgICBhZHBjbU9sZGVyID0gYWRwY21PbGQ7CiAgICAgICAgICAgICAgICAgICAgYWRwY21PbGQgPSBzYW1wbGVWYWx1ZTI7CgogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlclNhbXBsZSArPSAyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcmV0dXJuIGkgKyAxOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgLy8gUENNMTYKICAgICAgICAgICAgaWYgKGJsb2NrU2l6ZSAlIDIgIT0gMCkgewogICAgICAgICAgICAgICAgLy8gSSBkb24ndCB3YW50IHRvIGFjY2VwdCB0aGUgcG9zc2liaWxpdHkgdGhhdCBhIHNhbXBsZSBjYW4gYmUgZGl2aWRlZCBieSBhIGNodW5rIGJvdW5kYXJ5CiAgICAgICAgICAgICAgICB0aGlzLmRlY29kZXJFcnJvcigiQmxvY2sgc2l6ZSBub3QgZGl2aXNpYmxlIGJ5IDIsIGFzIHJlcXVpcmVkIGJ5IFBDTTE2IGVuY29kaW5nLiBSZW1haW5pbmcgYnl0ZXMgd2lsbCBiZSBpZ25vcmVkLiIpOwogICAgICAgICAgICAgICAgdGhpcy5kZWNvZGVyRmluaXNoZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZXIgPSAoY2hhbm5lbCwgaSkgPT4gewogICAgICAgICAgICAgICAgbGV0IHNhbXBsZVZhbHVlID0gKHRoaXMuYXN0RGF0YVtpXSA8PCA4KSB8IHRoaXMuYXN0RGF0YVtpICsgMV07CiAgICAgICAgICAgICAgICBzYW1wbGVWYWx1ZSAtPSAoc2FtcGxlVmFsdWUgJiAweDgwMDApIDw8IDE7CiAgICAgICAgICAgICAgICB0aGlzLmRlY29kZWRTYW1wbGVzW2NoYW5uZWxdLnB1c2goc2FtcGxlVmFsdWUpOwogICAgICAgICAgICAgICAgcmV0dXJuIGkgKyAyOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuZGVjb2RlclNhbXBsZSArPSBibG9ja1NpemUgKiAwLjU7CiAgICAgICAgfQogICAgICAgIC8vIEl0ZXJhdGUgdGhyb3VnaCBieXRlcyBpbiBldmVyeSBibG9jayBpbiB0aGlzIGNodW5rCiAgICAgICAgY29uc3Qgc3RhcnRTYW1wbGUgPSB0aGlzLmRlY29kZXJTYW1wbGU7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCB0aGlzLmhlYWRlci5udW1DaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgICAgIGNvbnN0IGJsb2NrRW5kID0gaSArIGJsb2NrU2l6ZTsKICAgICAgICAgICAgaWYgKHRoaXMuaGVhZGVyLmF1ZGlvRm9ybWF0ID09PSAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLmRlY29kZXJTYW1wbGUgPSBzdGFydFNhbXBsZTsKICAgICAgICAgICAgICAgIGFkcGNtU2hpZnQgPSB0aGlzLmFkcGNtU2hpZnRbY2hhbm5lbF07CiAgICAgICAgICAgICAgICBhZHBjbUZpbHRlciA9IHRoaXMuYWRwY21GaWx0ZXJbY2hhbm5lbF07CiAgICAgICAgICAgICAgICBhZHBjbU9sZCA9IHRoaXMuYWRwY21PbGRbY2hhbm5lbF07CiAgICAgICAgICAgICAgICBhZHBjbU9sZGVyID0gdGhpcy5hZHBjbU9sZGVyW2NoYW5uZWxdOwogICAgICAgICAgICAgICAgYWRwY21MYXN0Qnl0ZVdhc0hlYWRlciA9IHRoaXMuYWRwY21MYXN0Qnl0ZVdhc0hlYWRlcltjaGFubmVsXTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZSAoaSA8IGJsb2NrRW5kKSB7CiAgICAgICAgICAgICAgICBpZiAoaSA+PSB0aGlzLmFzdERhdGEubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXh0cmFCeXRlcyA9IChjaHVua1N0YXJ0ICsgdGhpcy5oZWFkZXIubnVtQ2hhbm5lbHMgKiBibG9ja1NpemUpIC0gdGhpcy5hc3REYXRhLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBpZiAoTWF0aC5mbG9vcihleHRyYUJ5dGVzIC8gYmxvY2tTaXplKSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5kZWNvZGVyRXJyb3IoIlJlYWNoZWQgZW5kIG9mIGZpbGUgYmVmb3JlIGV4cGVjdGVkIGVuZCBvZiBibG9jay4gRXhwZWN0ZWQgIiArIChleHRyYUJ5dGVzICUgYmxvY2tTaXplKSArICIgbW9yZSBieXRlcyBpbiBibG9jayBhbmQgIiArIE1hdGguZmxvb3IoZXh0cmFCeXRlcyAvIGJsb2NrU2l6ZSkgKyAiIG1vcmUgYmxvY2tzIGluIEJMQ0sgY2h1bmsuXG4iKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY29kZXJFcnJvcigiUmVhY2hlZCBlbmQgb2YgZmlsZSBiZWZvcmUgZXhwZWN0ZWQgZW5kIG9mIGJsb2NrLiBFeHBlY3RlZCAiICsgKGV4dHJhQnl0ZXMgJSBibG9ja1NpemUpICsgIiBtb3JlIGJ5dGVzIGluIGJsb2NrLiIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLmRlY29kZXJFbmRTYW1wbGUgPSB0aGlzLmRlY29kZWRTYW1wbGVzW3RoaXMuZGVjb2RlZFNhbXBsZXMubGVuZ3RoIC0gMV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIHRoaXMuZGVjb2RlckZpbmlzaGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpID0gaXRlcihjaGFubmVsLCBpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5oZWFkZXIuYXVkaW9Gb3JtYXQgPT09IDApIHsKICAgICAgICAgICAgICAgIHRoaXMuYWRwY21TaGlmdFtjaGFubmVsXSA9IGFkcGNtU2hpZnQ7CiAgICAgICAgICAgICAgICB0aGlzLmFkcGNtRmlsdGVyW2NoYW5uZWxdID0gYWRwY21GaWx0ZXI7CiAgICAgICAgICAgICAgICB0aGlzLmFkcGNtT2xkW2NoYW5uZWxdID0gYWRwY21PbGQ7CiAgICAgICAgICAgICAgICB0aGlzLmFkcGNtT2xkZXJbY2hhbm5lbF0gPSBhZHBjbU9sZGVyOwogICAgICAgICAgICAgICAgdGhpcy5hZHBjbUxhc3RCeXRlV2FzSGVhZGVyW2NoYW5uZWxdID0gYWRwY21MYXN0Qnl0ZVdhc0hlYWRlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAvL2NvbnNvbGUubG9nKCJEZWNvZGVkIGJsb2NrICIgKyB0aGlzLm51bUNodW5rcyk7CiAgICAgICAgdGhpcy5udW1DaHVua3MrKzsKICAgICAgICB0aGlzLmRlY29kZXJQb3NpdGlvbiA9IGk7CiAgICAgICAgdGhpcy5kZWNvZGVyRW5kU2FtcGxlID0gdGhpcy5kZWNvZGVkU2FtcGxlc1t0aGlzLmRlY29kZWRTYW1wbGVzLmxlbmd0aCAtIDFdLmxlbmd0aDsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICBkZWNvZGVyRXJyb3IobWVzc2FnZSkgewogICAgICAgIG1lc3NhZ2UgPSAiRGVjb2RpbmcgRXJyb3I6ICIgKyBtZXNzYWdlOwogICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgICB9CgogICAgc2V0UG9zaXRpb24oc2FtcGxlKSB7CiAgICAgICAgdGhpcy5vdXRwdXRTYW1wbGUgPSBzYW1wbGU7CiAgICB9CgogICAgZ2V0UG9zaXRpb24oKSB7CiAgICAgICAgcmV0dXJuIHRoaXMub3V0cHV0U2FtcGxlOwogICAgfQoKICAgIGdldFNhbXBsZSgpIHsKICAgICAgICB3aGlsZSAodGhpcy5kZWNvZGVyU2FtcGxlIDw9IHRoaXMub3V0cHV0U2FtcGxlKSB7CiAgICAgICAgICAgIGlmICghdGhpcy5uZXh0QmxvY2soKSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMub3V0cHV0U2FtcGxlID09PSB0aGlzLmhlYWRlci5sb29wRW5kIHx8IHRoaXMub3V0cHV0U2FtcGxlID49IHRoaXMuZGVjb2RlckVuZFNhbXBsZSkgewogICAgICAgICAgICB0aGlzLm91dHB1dFNhbXBsZSA9ICh0aGlzLmhlYWRlci5sb29wU3RhcnQgPCB0aGlzLmRlY29kZXJFbmRTYW1wbGUpID8gdGhpcy5oZWFkZXIubG9vcFN0YXJ0IDogMDsKICAgICAgICB9CiAgICAgICAgY29uc3QgY2hhbm5lbFNhbXBsZXMgPSBBcnJheSh0aGlzLmhlYWRlci5udW1DaGFubmVscyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCB0aGlzLmhlYWRlci5udW1DaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgICAgIGlmICh0aGlzLm91dHB1dFNhbXBsZSA8IHRoaXMuZGVjb2RlZFNhbXBsZXNbY2hhbm5lbF0ubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBjaGFubmVsU2FtcGxlc1tjaGFubmVsXSA9IHRoaXMuZGVjb2RlZFNhbXBsZXNbY2hhbm5lbF1bdGhpcy5vdXRwdXRTYW1wbGVdOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY2hhbm5lbFNhbXBsZXNbY2hhbm5lbF0gPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMub3V0cHV0U2FtcGxlKys7CiAgICAgICAgcmV0dXJuIGNoYW5uZWxTYW1wbGVzOwogICAgfQoKICAgIGdldFNhbXBsZXMobnVtU2FtcGxlcykgewogICAgICAgIGlmIChudW1TYW1wbGVzIDw9IDApIHsKICAgICAgICAgICAgY29uc3Qgc2FtcGxlcyA9IEFycmF5KHRoaXMuaGVhZGVyLm51bUNoYW5uZWxzKTsKICAgICAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCB0aGlzLmhlYWRlci5udW1DaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgICAgICAgICBzYW1wbGVzW2NoYW5uZWxdID0gW107CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNhbXBsZXM7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIGxldCBlbmRTYW1wbGUgPSB0aGlzLm91dHB1dFNhbXBsZSArIG51bVNhbXBsZXM7CiAgICAgICAgd2hpbGUgKGVuZFNhbXBsZSA+IHRoaXMuZGVjb2RlckVuZFNhbXBsZSkgewogICAgICAgICAgICBpZiAoIXRoaXMubmV4dEJsb2NrKCkpIHsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCBsb29wRW5kID0gTWF0aC5taW4odGhpcy5oZWFkZXIubG9vcEVuZCwgdGhpcy5kZWNvZGVyRW5kU2FtcGxlKTsKICAgICAgICBpZiAodGhpcy5vdXRwdXRTYW1wbGUgPT09IGxvb3BFbmQgfHwgdGhpcy5vdXRwdXRTYW1wbGUgPj0gdGhpcy5kZWNvZGVyRW5kU2FtcGxlKSB7CiAgICAgICAgICAgIHRoaXMub3V0cHV0U2FtcGxlID0gKHRoaXMuaGVhZGVyLmxvb3BTdGFydCA8IHRoaXMuZGVjb2RlckVuZFNhbXBsZSkgPyB0aGlzLmhlYWRlci5sb29wU3RhcnQgOiAwOwogICAgICAgICAgICBlbmRTYW1wbGUgPSB0aGlzLm91dHB1dFNhbXBsZSArIG51bVNhbXBsZXM7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLm91dHB1dFNhbXBsZSA8IGxvb3BFbmQgJiYgZW5kU2FtcGxlID4gbG9vcEVuZCkgewogICAgICAgICAgICAvLyBJZiB0aGUgcmFuZ2UgY29udGFpbnMgdGhlIGxvb3AgcG9pbnQsIHNwbGl0IGl0IGludG8gdHdvIGNvbnRpZ3VvdXMgcmFuZ2VzCiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMgPSB0aGlzLmdldFNhbXBsZXMobG9vcEVuZCAtIHRoaXMub3V0cHV0U2FtcGxlKTsKICAgICAgICAgICAgdGhpcy5vdXRwdXRTYW1wbGUgPSAodGhpcy5oZWFkZXIubG9vcFN0YXJ0IDwgdGhpcy5kZWNvZGVyRW5kU2FtcGxlKSA/IHRoaXMuaGVhZGVyLmxvb3BTdGFydCA6IDA7CiAgICAgICAgICAgIGNvbnN0IHNhbXBsZXMyID0gdGhpcy5nZXRTYW1wbGVzKGVuZFNhbXBsZSAtIGxvb3BFbmQpOwogICAgICAgICAgICBmb3IgKGxldCBjaGFubmVsID0gMDsgY2hhbm5lbCA8IHRoaXMuaGVhZGVyLm51bUNoYW5uZWxzOyBjaGFubmVsKyspIHsKICAgICAgICAgICAgICAgIHNhbXBsZXNbY2hhbm5lbF0ucHVzaCguLi5zYW1wbGVzMltjaGFubmVsXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNhbXBsZXM7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHNhbXBsZXMgPSBBcnJheSh0aGlzLmhlYWRlci5udW1DaGFubmVscyk7CiAgICAgICAgZm9yIChsZXQgY2hhbm5lbCA9IDA7IGNoYW5uZWwgPCB0aGlzLmhlYWRlci5udW1DaGFubmVsczsgY2hhbm5lbCsrKSB7CiAgICAgICAgICAgIHNhbXBsZXNbY2hhbm5lbF0gPSB0aGlzLmRlY29kZWRTYW1wbGVzW2NoYW5uZWxdLnNsaWNlKHRoaXMub3V0cHV0U2FtcGxlLCBlbmRTYW1wbGUpOwogICAgICAgIH0KICAgICAgICB0aGlzLm91dHB1dFNhbXBsZSA9IGVuZFNhbXBsZTsKICAgICAgICByZXR1cm4gc2FtcGxlczsKICAgIH0KfQoKLyoqCiAqIFJlYWQgYmlnLWVuZGlhbiB2YWx1ZSBmcm9tIGJ5dGUgYXJyYXkgc3RhcnRpbmcgYXQgcG9zaXRpb24KICogQHBhcmFtIHtudW1iZXJbXX0gYXJyYXkgc291cmNlIGFycmF5IG9mIGJ5dGVzCiAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydCBpbmRleCBvZiBmaXJzdCBieXRlICh0aGUgbW9zdCBzaWduaWZpY2FudCBieXRlIGluIHRoZSByZXN1bHRpbmcgdmFsdWUpCiAqIEBwYXJhbSB7bnVtYmVyfSBudW1CeXRlcyBudW1iZXIgb2YgYnl0ZXMgdG8gcmVhZAogKiBAcmV0dXJucyB7bnVtYmVyfSBjb21iaW5lZCB2YWx1ZQogKi8KZnVuY3Rpb24gcmVhZEJFKGFycmF5LCBzdGFydCwgbnVtQnl0ZXMpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgbnVtQnl0ZXM7CiAgICBsZXQgdmFsdWUgPSAwOwogICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpKyspIHsKICAgICAgICB2YWx1ZSA9ICh2YWx1ZSA8PCA4KSArIGFycmF5W2ldOwogICAgfQogICAgcmV0dXJuIHZhbHVlID4+PiAwOwp9CgovKioKICogUmVhZCBsaXR0bGUtZW5kaWFuIHZhbHVlIGZyb20gYnl0ZSBhcnJheSBzdGFydGluZyBhdCBwb3NpdGlvbgogKiBAcGFyYW0ge251bWJlcltdfSBhcnJheSBzb3VyY2UgYXJyYXkgb2YgYnl0ZXMKICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0IGluZGV4IG9mIGZpcnN0IGJ5dGUgKHRoZSBsZWFzdCBzaWduaWZpY2FudCBieXRlIGluIHRoZSByZXN1bHRpbmcgdmFsdWUpCiAqIEBwYXJhbSB7bnVtYmVyfSBudW1CeXRlcyBudW1iZXIgb2YgYnl0ZXMgdG8gcmVhZAogKiBAcmV0dXJucyB7bnVtYmVyfSBjb21iaW5lZCB2YWx1ZQogKi8KZnVuY3Rpb24gcmVhZExFKGFycmF5LCBzdGFydCwgbnVtQnl0ZXMpIHsKICAgIGNvbnN0IGVuZCA9IHN0YXJ0ICsgbnVtQnl0ZXM7CiAgICBsZXQgdmFsdWUgPSAwOwogICAgZm9yIChsZXQgaSA9IGVuZCAtIDE7IGkgPj0gc3RhcnQ7IGktLSkgewogICAgICAgIHZhbHVlID0gKHZhbHVlIDw8IDgpICsgYXJyYXlbaV07CiAgICB9CiAgICByZXR1cm4gdmFsdWUgPj4+IDA7Cn0KCmNvbnN0IGFkcGNtRmlsdGVyQ29lZmZpY2llbnRzID0gWwogICAgWzAsIDBdLAogICAgWzIwNDgsIDBdLAogICAgWzAsIDIwNDhdLAogICAgWzEwMjQsIDEwMjRdLAogICAgWzQwOTYsIC0yMDQ4XSwKICAgIFszNTg0LCAtMTUzNl0sCiAgICBbMzA3MiwgLTEwMjRdLAogICAgWzQ2MDgsIC0yNTYwXSwKICAgIFs0MjAwLCAtMjI0OF0sCiAgICBbNDgwMCwgLTIzMDBdLAogICAgWzUxMjAsIC0zMDcyXSwKICAgIFsyMDQ4LCAtMjA0OF0sCiAgICBbMTAyNCwgLTEwMjRdLAogICAgWy0xMDI0LCAxMDI0XSwKICAgIFstMTAyNCwgMF0sCiAgICBbLTIwNDgsIDBdLApdCgovKioKICogRGVjb2RlIGEgc2FtcGxlIG9mIEFEUENNIGF1ZGlvCiAqIEBwYXJhbSB7bnVtYmVyfSBzaGlmdCBTaGlmdCBhbW91bnQsIGZyb20gdGhlIHVwcGVyIDQgYml0cyBvZiB0aGUgaGVhZGVyIGJ5dGUgb2YgdGhlIGN1cnJlbnQgQURQQ00gYmxvY2sKICogQHBhcmFtIHtudW1iZXJ9IGZpbHRlciBTZWxlY3RzIGEgcm93IGZyb20gdGhlIGZpbHRlciBjb2VmZmljaWVudCB0YWJsZSwgZnJvbSB0aGUgbG93ZXIgNCBiaXRzIG9mIHRoZSBoZWFkZXIgYnl0ZSBvZiB0aGUgY3VycmVudCBBRFBDTSBibG9jawogKiBAcGFyYW0ge251bWJlcn0gbmliYmxlIDQtYml0IHZhbHVlIHRha2VuIGZyb20gdGhlIEFEUENNIGJsb2NrLCB1c2VkIHRvIGRldGVybWluZSB0aGUgbmV4dCBzYW1wbGUKICogQHBhcmFtIHtudW1iZXJ9IG9sZCBUaGUgaW1tZWRpYXRlIHByZXZpb3VzIDE2LWJpdCBkZWNvZGVkIHNhbXBsZQogKiBAcGFyYW0ge251bWJlcn0gb2xkZXIgVGhlIG5leHQgcHJldmlvdXMgMTYtYml0IGRlY29kZWQgc2FtcGxlOyB0aGUgb25lIGJlZm9yZSBvbGQKICogQHJldHVybnMge251bWJlcn0gMTYtYml0IGRlY29kZWQgc2FtcGxlCiAqLwpmdW5jdGlvbiBhZHBjbURlY29kZShzaGlmdCwgZmlsdGVyLCBuaWJibGUsIG9sZCwgb2xkZXIpIHsKICAgIC8vIEFEUENNIHNhbXBsZXMgYXJlIGFycmFuZ2VkIGluIGJsb2NrcyBvZiA5IGJ5dGVzOyB0aGUgZmlyc3QgYnl0ZSBpcyB0aGUgaGVhZGVyIGJ5dGUsCiAgICAvLyBhbmQgdGhlIG5pYmJsZXMgb2YgdGhlIHJlbWFpbmluZyBieXRlcyBhcyB3ZWxsIGFzIHRoZSB2YWx1ZXMgb2YgdGhlIHR3byBwcmV2aW91cwogICAgLy8gZGVjb2RlZCBzYW1wbGVzIGFyZSB1c2VkIHRvIGNvbnN0cnVjdCB0aGUgbmV4dCAxNiAxNi1iaXQgc2FtcGxlcy4KICAgIAogICAgbmliYmxlIC09IChuaWJibGUgJiAwYjEwMDApIDw8IDE7CiAgICBsZXQgcmVzdWx0ID0gbmliYmxlIDw8IHNoaWZ0OwogICAgcmVzdWx0ICs9IChvbGQgKiBhZHBjbUZpbHRlckNvZWZmaWNpZW50c1tmaWx0ZXJdWzBdICsgb2xkZXIgKiBhZHBjbUZpbHRlckNvZWZmaWNpZW50c1tmaWx0ZXJdWzFdKSA+PiAxMTsKCiAgICAvLyBDbGFtcCB0byAxNiBiaXRzCiAgICBpZiAocmVzdWx0ID4gMHg3RkZGKSB7CiAgICAgICAgcmVzdWx0ID0gMHg3RkZGOwogICAgfSBlbHNlIGlmIChyZXN1bHQgPCAtMHg4MDAwKSB7CiAgICAgICAgcmVzdWx0ID0gLTB4ODAwMDsKICAgIH0KICAgIHJldHVybiByZXN1bHQ7Cn0KCg==";

/**
 * AudioWorkletProcessor that outputs audio from AST file data
 */
class ASTAudioProcessor extends AudioWorkletProcessor {
    constructor(options) {
        super();
        this.astDecoder = new ASTDecoder(options.processorOptions.astData);
        this.numTracks = Math.ceil(this.astDecoder.header.numChannels * 0.5);
        this.trackVolumes = Array(this.numTracks).fill(0);
        this.trackVolumes[0] = 1;

        this.port.onmessage = (message) => {
            // Send back the current position whenever requested.
            switch (message.data.type) {
                case "get_position":
                    this.port.postMessage({type: "position", param: this.astDecoder.getPosition()});
                    break;
                case "set_position":
                    this.astDecoder.setPosition(+message.data.param);
                    break;
                case "set_track_volume":
                    if (message.data.param.trackNum in this.trackVolumes) {
                        this.trackVolumes[message.data.param.trackNum] = Math.max(-1, Math.min(message.data.param.value, 1));
                    }
                    break;
            }
        };
    }

    process(inputs, outputs, parameters) {
        let outputLength = outputs[0][0].length;
        for (let sample = 0; sample < outputLength; sample++) {
            const samples = this.astDecoder.getSample();
            for (let channel = 0; channel < Math.min(2, outputs[0].length); channel++) {
                let finalSample = 0;
                for (let track = 0; track < this.numTracks; track++) {
                    // Convert from 16-bit signed int to the -1 to 1 floating point range.
                    let sampleValue = samples[Math.min(2 * track + channel, samples.length - 1)] / 32767;
    
                    // Can't be too careful
                    sampleValue = Math.max(-1, Math.min(sampleValue, 1));
                    
                    finalSample += sampleValue * this.trackVolumes[track];
                }
                outputs[0][channel][sample] = finalSample;
            }
        }
        return true;
    }
}

registerProcessor('ast-audio-processor', ASTAudioProcessor);
